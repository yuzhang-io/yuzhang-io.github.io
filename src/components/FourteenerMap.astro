---
const {
  coDataUrl = "/data/co-14ers.json",
  myDataUrl = "/data/my-14ers.json",
  mapId = "co14ersMap",
  statusId = "co14ersStatus",
  countId = "co14ersCount",
  heroDoneId = "hero14ersDone",
  heroTotalId = "hero14ersTotal",
} = Astro.props as {
  coDataUrl?: string;
  myDataUrl?: string;
  mapId?: string;
  statusId?: string;
  countId?: string;
  heroDoneId?: string;
  heroTotalId?: string;
};
---

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>

<!-- Component-local styles (layout wrappers, etc.) -->
<style>
  /* Fixed-height wrapper gives Leaflet something stable */
  .leaflet-container {
    background: transparent;
    border-radius: 1rem;
  }

  /* Hillshade tiles look best with a blend */
  .leaflet-tile.hillshade-tile {
    mix-blend-mode: multiply;
  }
</style>

<!-- IMPORTANT: Leaflet DOM is injected at runtime, so make these GLOBAL -->
<style is:global>
  /* ===========================
     CYBER MARKERS (SVG PATHS)
     =========================== */

  .peak-marker {
    transition: filter 140ms ease, opacity 140ms ease;
  }

  .peak-marker.peak-notyet {
    opacity: 0.65;
    filter: drop-shadow(0 0 0 rgba(0, 0, 0, 0));
  }

  .peak-marker.peak-notyet:hover {
    opacity: 1;
    filter: drop-shadow(0 0 10px rgba(226, 232, 240, 0.35));
    cursor: pointer;
  }

  .peak-marker.peak-climbed {
    filter: drop-shadow(0 0 10px rgba(0, 255, 204, 0.55));
  }

  .peak-marker.peak-climbed:hover {
    filter: drop-shadow(0 0 14px rgba(0, 255, 204, 0.85));
    cursor: pointer;
  }

  /* ===========================
     LEAFLET UI (DARK MODE)
     =========================== */

  /* Force all Leaflet control containers transparent (prevents “white blocks”) */
  .leaflet-container .leaflet-control {
    background: transparent !important;
    box-shadow: none !important;
  }

  .leaflet-control-zoom,
  .leaflet-control-layers {
    border: 1px solid rgba(63, 63, 70, 0.6) !important;
    border-radius: 12px !important;
    overflow: hidden;
    box-shadow: none !important;
    backdrop-filter: blur(10px);
    background: rgba(9, 9, 11, 0.55) !important;
  }

  /* Zoom buttons */
  .leaflet-control-zoom a.leaflet-control-zoom-in,
  .leaflet-control-zoom a.leaflet-control-zoom-out {
    background: rgba(9, 9, 11, 0.65) !important;
    color: rgba(244, 244, 245, 0.95) !important;
    border-bottom: 1px solid rgba(63, 63, 70, 0.6) !important;
  }
  .leaflet-control-zoom a.leaflet-control-zoom-out {
    border-bottom: none !important;
  }
  .leaflet-control-zoom a:hover {
    background: rgba(255, 255, 255, 0.08) !important;
  }
  .leaflet-control-zoom a.leaflet-disabled {
    color: rgba(244, 244, 245, 0.35) !important;
  }

  /* Layers button (icon is a background-image, so we invert it) */
  .leaflet-control-layers-toggle {
    background-color: rgba(9, 9, 11, 0.65) !important;
    border-radius: 10px !important;
    filter: invert(1) brightness(1.2) contrast(1.1) !important;
  }
  .leaflet-control-layers-toggle:hover {
    background-color: rgba(255, 255, 255, 0.08) !important;
  }

  .leaflet-control-layers-expanded {
    padding: 10px 12px !important;
    background: rgba(9, 9, 11, 0.65) !important;
  }

  .leaflet-control-layers label {
    color: rgba(244, 244, 245, 0.9) !important;
    font-size: 12px;
  }

  .leaflet-control-attribution {
    background: rgba(9, 9, 11, 0.55) !important;
    color: rgba(244, 244, 245, 0.75) !important;
    border: 1px solid rgba(63, 63, 70, 0.5);
    border-radius: 10px;
    padding: 3px 8px;
    backdrop-filter: blur(10px);
  }

  .leaflet-control-attribution a {
    color: rgba(244, 244, 245, 0.85) !important;
  }

  /* Reset button (matches Leaflet bar styling) */
  .leaflet-container .leaflet-control-reset a {
    background: rgba(9, 9, 11, 0.65) !important;
    color: rgba(244, 244, 245, 0.95) !important;
    text-decoration: none !important;
    font-size: 16px;
    line-height: 26px;
  }
  .leaflet-container .leaflet-control-reset a:hover {
    background: rgba(255, 255, 255, 0.08) !important;
  }
</style>

<section class="rounded-3xl border border-zinc-200 bg-white p-5 shadow-sm dark:border-zinc-800 dark:bg-zinc-900/40">
  <div class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
    <div>
      <h2 class="text-lg font-semibold tracking-tight">Colorado 14ers Map</h2>
    </div>

    <span
      id={countId}
      class="inline-flex items-center gap-2 rounded-full border border-zinc-200 px-3 py-1 text-xs text-zinc-600 dark:border-zinc-800 dark:text-zinc-300"
    >
      — / — climbed
    </span>
  </div>

  <div class="mt-4 grid gap-4 lg:grid-cols-5">
    <div class="lg:col-span-3">
      <!-- Fixed-height map wrapper so it matches the list -->
      <div
        id={`${mapId}Wrap`}
        class="relative h-[440px] overflow-hidden rounded-2xl ring-1 ring-zinc-200 dark:ring-zinc-800"
      >
        <div id={mapId} class="absolute inset-0 rounded-2xl"></div>

        <!-- status overlay (does not change layout height) -->
        <div
          id={statusId}
          class="pointer-events-none absolute bottom-3 left-3 rounded-xl border border-zinc-200 bg-white/85 px-3 py-1 text-xs text-zinc-700 shadow-sm backdrop-blur dark:border-zinc-800 dark:bg-zinc-950/55 dark:text-zinc-200"
        >
          Loading peaks…
        </div>
      </div>
    </div>

    <aside class="lg:col-span-2">
      <!-- Fixed-height list card to match map height -->
      <div class="h-[440px] rounded-2xl border border-zinc-200 bg-white p-4 shadow-sm dark:border-zinc-800 dark:bg-zinc-900/40 flex flex-col">
        <div class="flex items-center justify-between gap-3">
          <div class="text-sm font-semibold text-zinc-900 dark:text-white">Peaks</div>
          <input
            id="peakSearch"
            type="search"
            placeholder="Search…"
            class="w-44 rounded-xl border border-zinc-200 bg-white px-3 py-1.5 text-xs text-zinc-700 outline-none placeholder:text-zinc-400 focus:border-zinc-300 dark:border-zinc-800 dark:bg-zinc-950/40 dark:text-zinc-200 dark:placeholder:text-zinc-500"
          />
        </div>

        <div class="mt-3 flex-1 overflow-y-auto pr-1">
          <div id="peakList" class="grid gap-2"></div>
        </div>

        <div class="mt-3 text-xs text-zinc-500 dark:text-zinc-400">
          Sorted by elevation. Click to fly to a peak.
        </div>
      </div>
    </aside>
  </div>

  <script
    is:inline
    define:vars={{
      coDataUrl,
      myDataUrl,
      mapId,
      statusId,
      countId,
      heroDoneId,
      heroTotalId,
    }}
  >
    (function () {
      var CO_URL = coDataUrl;
      var MY_URL = myDataUrl;
      var MAP_ID = mapId;
      var STATUS_ID = statusId;
      var COUNT_ID = countId;
      var HERO_DONE_ID = heroDoneId;
      var HERO_TOTAL_ID = heroTotalId;

      function $(id) { return document.getElementById(id); }

      function setStatus(msg) {
        var el = $(STATUS_ID);
        if (!el) return;
        el.textContent = msg || "";
        el.style.display = msg ? "block" : "none";
      }

      function normalize(s) {
        s = (s || "").toLowerCase();
        s = s.replace(/mount\s+/g, "mt ");
        s = s.replace(/\bmt\.\s*/g, "mt ");
        s = s.replace(/[()]/g, " ");
        s = s.replace(/[^a-z0-9\s]/g, "");
        s = s.replace(/\s+/g, " ").trim();
        return s;
      }

      function setCount(done, total) {
        var pill = $(COUNT_ID);
        if (pill) pill.textContent = done + " / " + total + " climbed";

        var heroDone = $(HERO_DONE_ID);
        var heroTotal = $(HERO_TOTAL_ID);
        if (heroDone) heroDone.textContent = String(done);
        if (heroTotal) heroTotal.textContent = String(total);
      }

      // Climbed: neon mint filled dot + white ring halo
      function markerOptsClimbed() {
        return {
          radius: 5,
          stroke: true,
          color: "#ffffff",
          weight: 1,
          opacity: 0.95,
          fill: true,
          fillColor: "#00c7a8",
          fillOpacity: 0.95,
        };
      }

      // Not yet: hollow grey ring
      function markerOptsNotYet() {
        return {
          radius: 5,
          stroke: true,
          color: "#e2e8f0",
          weight: 1,
          opacity: 0.75,
          fill: false,
        };
      }

      var CO_CLAMP_BOUNDS = [
        [36.7, -109.3],
        [41.2, -102.0],
      ];

      window.addEventListener("load", function () {
        var mapDiv = $(MAP_ID);
        if (!mapDiv) return setStatus("Map container not found.");
        if (!window.L) return setStatus("Leaflet failed to load (window.L is missing).");

        setStatus("Loading peaks…");

        Promise.all([
          fetch(CO_URL, { cache: "no-store" }).then(function (r) { return r.json(); }),
          fetch(MY_URL, { cache: "no-store" }).then(function (r) { return r.json(); }),
        ])
          .then(function (arr) {
            var coJson = arr[0];
            var myJson = arr[1];

            var coPeaks = (coJson && Array.isArray(coJson.peaks)) ? coJson.peaks : [];
            var myPeaks = (myJson && Array.isArray(myJson.peaks)) ? myJson.peaks : [];

            var climbedIds = {};
            var climbedNames = {};

            for (var i = 0; i < myPeaks.length; i++) {
              var p = myPeaks[i];
              if (p && p.climbed) {
                if (p.id) climbedIds[String(p.id)] = true;
                if (p.name) climbedNames[normalize(p.name)] = true;
              }
            }

            var total = coPeaks.length;
            var done = 0;
            for (var j = 0; j < coPeaks.length; j++) {
              var cp = coPeaks[j];
              var isDone =
                (cp && cp.id && climbedIds[String(cp.id)]) ||
                (cp && cp.name && climbedNames[normalize(cp.name)]);
              if (isDone) done++;
            }
            setCount(done, total);

            setStatus("Rendering map…");

            var map = window.L.map(MAP_ID, {
              scrollWheelZoom: false,
              renderer: window.L.svg(),
            });

            map.createPane("paneNotYet");
            map.getPane("paneNotYet").style.zIndex = 420;
            map.createPane("paneClimbed");
            map.getPane("paneClimbed").style.zIndex = 430;

            var MAPBOX_TOKEN = "pk.eyJ1Ijoiemhhbmd5dXR5biIsImEiOiJjbWplcjhmMHIwa2psM2tweTFyaTl3aWVmIn0.zCJY08mlW89VE-CNDsUaOg";
            var mapboxStyleTiles =
              "https://api.mapbox.com/styles/v1/zhangyutyn/cmjeroj9p001x01s1g91zapo2/tiles/256/{z}/{x}/{y}@2x?access_token=" +
              MAPBOX_TOKEN;

            var dark = window.L.tileLayer(mapboxStyleTiles, {
              maxZoom: 20,
              tileSize: 256,
              zoomOffset: 0,
              attribution: "&copy; Mapbox",
            });

            var topo = window.L.tileLayer(
              "https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",
              { maxZoom: 17, attribution: "&copy; OpenStreetMap contributors, &copy; OpenTopoMap" }
            );

            var relief = window.L.tileLayer(
              "https://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}",
              { maxZoom: 13, attribution: "Tiles &copy; Esri" }
            );

            var hillshade = window.L.tileLayer(
              "https://server.arcgisonline.com/ArcGIS/rest/services/Elevation/World_Hillshade/MapServer/tile/{z}/{y}/{x}",
              {
                maxZoom: 16,
                opacity: 0.35,
                className: "hillshade-tile",
                attribution: "Tiles &copy; Esri",
              }
            );

            var labels = window.L.tileLayer(
              "https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",
              { maxZoom: 19, opacity: 0.55, attribution: "Tiles &copy; Esri" }
            );

            dark.addTo(map);

            window.L.control.layers(
              { "Dark": dark, "Topo": topo, "Relief (clean)": relief },
              { "Hillshade": hillshade, "Labels": labels },
              { collapsed: true }
            ).addTo(map);

            window.L.control.scale({ imperial: true, metric: false, position: "bottomleft" }).addTo(map);

            // --- Add Reset View button ---
            var home = { center: null, zoom: null, bounds: null };

            var ResetControl = window.L.Control.extend({
              options: { position: "topleft" },
              onAdd: function () {
                var container = window.L.DomUtil.create("div", "leaflet-bar leaflet-control leaflet-control-reset");
                var a = window.L.DomUtil.create("a", "leaflet-control-reset-btn", container);
                a.href = "#";
                a.title = "Reset view";
                a.setAttribute("role", "button");
                a.setAttribute("aria-label", "Reset view");
                a.innerHTML = "⟳";

                window.L.DomEvent.disableClickPropagation(container);
                window.L.DomEvent.on(a, "click", function (e) {
                  window.L.DomEvent.preventDefault(e);
                  if (home.bounds) map.fitBounds(home.bounds, { padding: [18, 18], maxZoom: home.zoom });
                  else if (home.center && typeof home.zoom === "number") map.setView(home.center, home.zoom);
                });

                return container;
              }
            });

            map.addControl(new ResetControl());

            var bounds = [];
            var markerByKey = {};
            var listData = [];

            for (var k = 0; k < coPeaks.length; k++) {
              var pk = coPeaks[k];
              if (!pk || typeof pk.lat !== "number" || typeof pk.lon !== "number") continue;

              var climbed =
                (pk.id && climbedIds[String(pk.id)]) ||
                (pk.name && climbedNames[normalize(pk.name)]);

              var opts = climbed ? markerOptsClimbed() : markerOptsNotYet();
              opts.pane = climbed ? "paneClimbed" : "paneNotYet";
              opts.className = "peak-marker " + (climbed ? "peak-climbed" : "peak-notyet");

              var m = window.L.circleMarker([pk.lat, pk.lon], opts).addTo(map);

              var elev = pk.elevation_ft ? ("<br/>" + pk.elevation_ft + " ft") : "";
              var rng = pk.range ? ("<br/>" + pk.range) : "";
              m.bindPopup("<b>" + pk.name + "</b>" + elev + rng + "<br/>" + (climbed ? "✓ climbed" : "not yet"));
              m.bindTooltip(pk.name, { direction: "top", opacity: 0.9, offset: [0, -8] });

              var key = pk.id ? String(pk.id) : String(k);
              markerByKey[key] = m;

              listData.push({
                key: key,
                name: pk.name || "Unknown",
                climbed: !!climbed,
                lat: pk.lat,
                lon: pk.lon,
                elevation_ft: (typeof pk.elevation_ft === "number" ? pk.elevation_ft : 0),
              });

              bounds.push([pk.lat, pk.lon]);
            }

            if (bounds.length) {
              var peakBounds = window.L.latLngBounds(bounds);
              var clampBounds = window.L.latLngBounds(CO_CLAMP_BOUNDS);
              var finalBounds = clampBounds.contains(peakBounds) ? peakBounds : clampBounds;

              map.fitBounds(finalBounds, { padding: [18, 18], maxZoom: 11 });

              // store the “home” view for reset
              home.bounds = window.L.latLngBounds(finalBounds);
              home.center = map.getCenter();
              home.zoom = map.getZoom();
            } else {
              map.setView([39.0, -105.7], 7);
              home.center = map.getCenter();
              home.zoom = map.getZoom();
            }

            // --- List rendering (SORT BY ELEVATION DESC) ---
            var listEl = $("peakList");
            var searchEl = $("peakSearch");

            function pillHtml(item) {
              var dot =
                '<span class="inline-flex h-5 w-5 items-center justify-center rounded-full ring-1 ' +
                (item.climbed
                  ? 'bg-emerald-500/15 text-emerald-600 ring-emerald-500/30 dark:text-emerald-300'
                  : 'bg-zinc-500/10 text-zinc-200 ring-zinc-500/25 dark:text-zinc-200') +
                '">' + (item.climbed ? "✓" : "•") + "</span>";

              var elev = item.elevation_ft
                ? ('<span class="ml-auto text-[11px] text-zinc-500 dark:text-zinc-400">' + item.elevation_ft + " ft</span>")
                : "";

              return (
                '<button data-key="' + item.key + '" class="group flex w-full items-center gap-2 rounded-xl border border-zinc-200 bg-zinc-50 px-3 py-2 text-left text-sm ' +
                'hover:bg-zinc-100 dark:border-zinc-800 dark:bg-zinc-900/30 dark:hover:bg-zinc-900/50">' +
                dot +
                '<span class="min-w-0 truncate text-zinc-900 dark:text-white">' + item.name + "</span>" +
                elev +
                "</button>"
              );
            }

            function renderList(filter) {
              if (!listEl) return;
              var q = (filter || "").toLowerCase().trim();
              var html = "";

              var sorted = listData.slice().sort(function (a, b) {
                if (b.elevation_ft !== a.elevation_ft) return b.elevation_ft - a.elevation_ft;
                if (a.climbed !== b.climbed) return a.climbed ? -1 : 1;
                return a.name.localeCompare(b.name);
              });

              for (var i2 = 0; i2 < sorted.length; i2++) {
                var it = sorted[i2];
                if (q && it.name.toLowerCase().indexOf(q) === -1) continue;
                html += pillHtml(it);
              }

              listEl.innerHTML = html;
            }

            renderList("");

            if (listEl) {
              listEl.addEventListener("click", function (e) {
                var t = e.target;
                var btn = t && t.closest ? t.closest("button[data-key]") : null;
                if (!btn) return;

                var key = btn.getAttribute("data-key");
                var m = markerByKey[key];
                if (!m) return;

                var ll = m.getLatLng();
                map.flyTo(ll, Math.max(map.getZoom(), 10), { duration: 0.8 });
                m.openPopup();
              });
            }

            if (searchEl) {
              searchEl.addEventListener("input", function () {
                renderList(searchEl.value);
              });
            }

            setStatus("");
          })
          .catch(function (err) {
            console.error("[FourteenerMap] failed:", err);
            setStatus("Map failed to load. Check Console for details.");
          });
      });
    })();
  </script>
</section>
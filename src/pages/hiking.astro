---
import BaseLayout from "../layouts/BaseLayout.astro";
import FourteenerMap from "../components/FourteenerMap.astro";

const INSTAGRAM = "https://instagram.com/zhangyupulpo";

// Auto-detect gallery files at build time
const galleryFiles = import.meta.glob("/public/img/hiking/gallery/*.{jpg,jpeg,png,webp}", {
  eager: true,
});

// Build a sorted list of URLs like /img/hiking/gallery/01.jpg
const GALLERY = Object.keys(galleryFiles)
  .map((p) => p.replace("/public", ""))
  .sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));

const NON_14ERS = [
  { name: "Torres del Paine — W Circuit", location: "Chile", date: "March 2016", note: "" },
  { name: "Guadalupe Peak", location: "Texas", date: "Dec 2021", note: "" },
];
---

<BaseLayout title="Hiking — Yu Zhang" description="Mountains, 14ers progress, and favorite routes.">
  <!-- Hero -->
  <section class="relative overflow-hidden rounded-3xl border border-zinc-200 shadow-sm dark:border-zinc-800">
    <div
      class="absolute inset-0"
      style="background: linear-gradient(135deg, rgb(6,147,227) 0%, rgb(14,11,11) 15%, rgb(15,7,7) 61%, rgb(155,81,224) 100%);"
    ></div>

    <div class="relative p-8 sm:p-10 text-white">
      <div class="flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between">
        <div>
          <h1 class="text-3xl sm:text-4xl font-semibold tracking-tight">Hiking</h1>
          <p class="mt-3 max-w-3xl text-white/85 leading-7">
            Colorado peaks, long days, and alpine miles. Tracking my 14ers and other climbs.
          </p>

          <div class="mt-4 flex flex-wrap gap-3">
            <div class="inline-flex items-center gap-2 rounded-2xl bg-white/10 px-4 py-2 ring-1 ring-white/15">
              <span class="text-sm font-semibold">14ers:</span>
              <span class="text-sm text-white/90">
                <span id="hero14ersDone">—</span> / <span id="hero14ersTotal">—</span>
              </span>
            </div>

            <div class="inline-flex items-center gap-2 rounded-2xl bg-white/10 px-4 py-2 ring-1 ring-white/15">
              <span class="text-sm font-semibold">NH 4Ks:</span>
              <span class="text-sm text-white/90">
                <span id="heroNhDone">—</span> / <span id="heroNhTotal">—</span>
              </span>
            </div>
          </div>
        </div>

        <div class="flex flex-wrap gap-3">
          <a
            href={INSTAGRAM}
            target="_blank"
            rel="noreferrer"
            class="rounded-xl bg-white/10 px-4 py-2 text-sm font-medium ring-1 ring-white/20 hover:bg-white/15"
          >
            Instagram ↗
          </a>
          <a
            href="https://www.14ers.com/"
            target="_blank"
            rel="noreferrer"
            class="rounded-xl bg-white/10 px-4 py-2 text-sm font-medium ring-1 ring-white/20 hover:bg-white/15"
          >
            14ers.com ↗
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Map -->
  <section class="mt-10">
    <FourteenerMap
      coDataUrl="/data/co-14ers.json"
      myDataUrl="/data/my-14ers.json"
      mapId="co14ersMap"
      statusId="co14ersStatus"
      countId="co14ersCount"
      heroDoneId="hero14ersDone"
      heroTotalId="hero14ersTotal"
    />
  </section>

  <!-- Gallery -->
  <section class="mt-10">
    <div class="flex items-end justify-between gap-4">
      <h2 class="text-lg font-semibold tracking-tight">Gallery</h2>
      <button
        id="toggleAll"
        class="text-sm text-zinc-500 hover:text-zinc-900 dark:text-zinc-400 dark:hover:text-white"
        type="button"
      >
        Show all
      </button>
    </div>

    {GALLERY.length ? (
      <>
        <!-- Filmstrip (first 12) -->
        <div id="filmstrip" class="mt-4 flex gap-3 overflow-x-auto pb-2">
          {GALLERY.slice(0, 12).map((src) => (
            <button
              class="group relative shrink-0 overflow-hidden rounded-2xl border border-zinc-200 bg-zinc-50 shadow-sm dark:border-zinc-800 dark:bg-zinc-900/40"
              style="width: 220px;"
              data-full={src}
            >
              <img
                src={src}
                alt=""
                class="h-36 w-full object-cover transition group-hover:scale-[1.02]"
                loading="lazy"
              />
            </button>
          ))}
        </div>

        <!-- Full grid (hidden by default) -->
        <div id="allGrid" class="mt-4 hidden grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
          {GALLERY.map((src) => (
            <button
              class="group relative overflow-hidden rounded-2xl border border-zinc-200 bg-zinc-50 shadow-sm dark:border-zinc-800 dark:bg-zinc-900/40"
              data-full={src}
            >
              <img src={src} alt="" class="h-56 w-full object-cover transition group-hover:scale-[1.02]" loading="lazy" />
            </button>
          ))}
        </div>
      </>
    ) : (
      <div class="mt-4 rounded-2xl border border-zinc-200 bg-white p-5 text-sm text-zinc-600 dark:border-zinc-800 dark:bg-zinc-900/40 dark:text-zinc-300">
        No images found in <span class="font-mono">public/img/hiking/gallery/</span>.
      </div>
    )}

    <!-- Lightbox -->
    <div id="lightbox" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 p-4">
      <button
        id="lightboxClose"
        class="absolute right-4 top-4 rounded-xl bg-white/10 px-3 py-2 text-sm font-semibold text-white ring-1 ring-white/20 hover:bg-white/15"
      >
        Close
      </button>
      <img id="lightboxImg" src="" alt="" class="max-h-[85vh] max-w-[95vw] rounded-2xl ring-1 ring-white/20" />
    </div>

    <script is:inline>
      (function () {
        var box = document.getElementById("lightbox");
        var img = document.getElementById("lightboxImg");
        var close = document.getElementById("lightboxClose");
        var film = document.getElementById("filmstrip");
        var grid = document.getElementById("allGrid");
        var toggle = document.getElementById("toggleAll");
        var showingAll = false;

        function openLightbox(src) {
          if (!img || !box) return;
          img.src = src;
          box.classList.remove("hidden");
          box.classList.add("flex");
        }
        function closeLightbox() {
          if (!img || !box) return;
          box.classList.add("hidden");
          box.classList.remove("flex");
          img.src = "";
        }

        function onClickContainer(e) {
          var t = e.target;
          var btn = t && t.closest ? t.closest("button[data-full]") : null;
          if (!btn) return;
          openLightbox(btn.dataset.full);
        }

        if (film) film.addEventListener("click", onClickContainer);
        if (grid) grid.addEventListener("click", onClickContainer);

        if (toggle && grid) {
          toggle.addEventListener("click", function () {
            showingAll = !showingAll;
            grid.classList.toggle("hidden", !showingAll);
            toggle.textContent = showingAll ? "Show less" : "Show all";
          });
        }

        if (close) close.addEventListener("click", closeLightbox);
        if (box) box.addEventListener("click", function (e) { if (e.target === box) closeLightbox(); });
        window.addEventListener("keydown", function (e) { if (e.key === "Escape") closeLightbox(); });
      })();
    </script>
  </section>

  <!-- NH 4K Checklist (compact) -->
  <section class="mt-10">
    <details open class="rounded-3xl border border-zinc-200 bg-white p-5 shadow-sm dark:border-zinc-800 dark:bg-zinc-900/40">
      <summary class="cursor-pointer list-none">
        <div class="flex items-end justify-between gap-4">
          <div>
            <h2 class="text-lg font-semibold tracking-tight">New Hampshire 4,000-footers</h2>
          </div>

          <span
            id="nhPill"
            class="inline-flex items-center gap-2 rounded-full border border-zinc-200 px-3 py-1 text-xs text-zinc-600 dark:border-zinc-800 dark:text-zinc-300"
          >
            — / — climbed
          </span>
        </div>
      </summary>

      <div class="mt-4">
        <div id="nhList" class="grid gap-2 sm:grid-cols-2 lg:grid-cols-3"></div>
        <div id="nhErr" class="mt-3 hidden text-sm text-zinc-500 dark:text-zinc-400"></div>
      </div>
    </details>

    <script is:inline>
      (function () {
        function $(id) { return document.getElementById(id); }

        var heroDone = $("heroNhDone");
        var heroTotal = $("heroNhTotal");
        var pill = $("nhPill");
        var list = $("nhList");
        var err = $("nhErr");

        function setCounts(done, total) {
          if (heroDone) heroDone.textContent = String(done);
          if (heroTotal) heroTotal.textContent = String(total);
          if (pill) pill.textContent = done + " / " + total + " climbed";
        }

        function itemHtml(p) {
          var done = !!(p && p.climbed);
          var name = (p && p.name) ? String(p.name) : "Unknown";
          var date = (p && p.date) ? String(p.date) : "";

          var badge =
            '<span class="inline-flex h-5 w-5 items-center justify-center rounded-full ring-1 ' +
            (done
              ? 'bg-emerald-500/15 text-emerald-600 ring-emerald-500/30 dark:text-emerald-300'
              : 'bg-violet-500/10 text-violet-600 ring-violet-500/25 dark:text-violet-300') +
            '">' + (done ? "✓" : "•") + "</span>";

          var dateHtml = date
            ? '<span class="ml-2 text-xs text-zinc-500 dark:text-zinc-400">' + date + "</span>"
            : "";

          return (
            '<div class="flex items-center gap-2 rounded-xl border border-zinc-200 bg-zinc-50 px-3 py-2 text-sm ' +
            'dark:border-zinc-800 dark:bg-zinc-900/30">' +
            badge +
            '<span class="min-w-0 truncate text-zinc-900 dark:text-white">' + name + "</span>" +
            dateHtml +
            "</div>"
          );
        }

        fetch("/data/my-nh4k.json", { cache: "no-store" })
          .then(function (r) { return r.json(); })
          .then(function (j) {
            var peaks = (j && Array.isArray(j.peaks)) ? j.peaks : [];
            var total = peaks.length;
            var done = 0;
            for (var i = 0; i < peaks.length; i++) if (peaks[i] && peaks[i].climbed) done++;

            setCounts(done, total);

            if (!list) return;
            var html = "";
            for (var k = 0; k < peaks.length; k++) html += itemHtml(peaks[k]);
            list.innerHTML = html;
          })
          .catch(function (e) {
            console.error("[NH4K] failed:", e);
            if (err) {
              err.textContent = "Could not load /data/my-nh4k.json";
              err.classList.remove("hidden");
            }
            setCounts(0, 0);
          });
      })();
    </script>
  </section>

  <!-- Non-14ers -->
  <section class="mt-10">
    <h2 class="text-lg font-semibold tracking-tight">Other climbs</h2>
    <div class="mt-4 grid gap-4 sm:grid-cols-2">
      {NON_14ERS.map((c) => (
        <div class="rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm dark:border-zinc-800 dark:bg-zinc-900/40">
          <div class="font-semibold">{c.name}</div>
          <div class="mt-1 text-sm text-zinc-600 dark:text-zinc-300">
            {c.location}{c.date ? ` · ${c.date}` : ""}
          </div>
          {c.note ? <div class="mt-3 text-sm text-zinc-500 dark:text-zinc-400">{c.note}</div> : null}
        </div>
      ))}
    </div>
  </section>
</BaseLayout>